{% extends 'base.html' %}

{% block title %}Edit Podcast - AI Podcast Creator{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Edit Podcast</h4>
                    <a href="{{ url_for('settings') }}" class="btn btn-sm btn-secondary">Back to Podcasts</a>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('update_settings', id=podcast.id) }}" enctype="multipart/form-data">
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="podcast_title" class="form-label">Podcast Title</label>
                                    <input type="text" class="form-control" id="podcast_title" name="podcast_title" value="{{ podcast.podcast_title }}" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="podcast_author" class="form-label">Podcast Author</label>
                                    <input type="text" class="form-control" id="podcast_author" name="podcast_author" value="{{ podcast.podcast_author }}" required>
                                    <div class="form-text">The author name displayed in podcast platforms.</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="host_name" class="form-label">Host Name</label>
                                    <input type="text" class="form-control" id="host_name" name="host_name" value="{{ podcast.host_name }}" placeholder="e.g. Sarah Johnson">
                                    <div class="form-text">The name of the podcast host mentioned in the script (if different from author).</div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="podcast_language" class="form-label">Language</label>
                                        <input type="text" class="form-control" id="podcast_language" name="podcast_language" value="{{ podcast.podcast_language }}" required>
                                        <div class="form-text">Format: en-us, es-es, etc.</div>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="podcast_category" class="form-label">Category</label>
                                        <select class="form-select" id="podcast_category" name="podcast_category">
                                            <option value="Technology" {% if podcast.podcast_category == 'Technology' %}selected{% endif %}>Technology</option>
                                            <option value="Business" {% if podcast.podcast_category == 'Business' %}selected{% endif %}>Business</option>
                                            <option value="News" {% if podcast.podcast_category == 'News' %}selected{% endif %}>News</option>
                                            <option value="Science" {% if podcast.podcast_category == 'Science' %}selected{% endif %}>Science</option>
                                            <option value="Education" {% if podcast.podcast_category == 'Education' %}selected{% endif %}>Education</option>
                                            <option value="Arts" {% if podcast.podcast_category == 'Arts' %}selected{% endif %}>Arts</option>
                                            <option value="Comedy" {% if podcast.podcast_category == 'Comedy' %}selected{% endif %}>Comedy</option>
                                        </select>
                                    </div>
                                </div>
                                

                                
                                <div class="mb-3">
                                    <label for="time_frame" class="form-label">Article Time Frame</label>
                                    <select class="form-select" id="time_frame" name="time_frame">
                                        <option value="today" {% if podcast.time_frame == 'today' %}selected{% endif %}>Today's Articles Only</option>
                                        <option value="week" {% if podcast.time_frame == 'week' %}selected{% endif %}>Last 7 Days</option>
                                        <option value="month" {% if podcast.time_frame == 'month' %}selected{% endif %}>Last 30 Days</option>
                                    </select>
                                    <div class="form-text">How far back should we look for articles?</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="podcast_duration" class="form-label">Target Podcast Duration</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="podcast_duration" name="podcast_duration" min="1" max="60" value="{{ podcast.podcast_duration }}" required>
                                        <span class="input-group-text">minutes</span>
                                    </div>
                                    <div class="form-text">Desired length of the podcast. Longer podcasts will include more detailed summaries and potentially more articles.</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="openai_model" class="form-label">AI Model</label>
                                    <select class="form-select" id="openai_model" name="openai_model">
                                        <option value="gpt-3.5-turbo" {% if podcast.openai_model == 'gpt-3.5-turbo' %}selected{% endif %}>GPT-3.5 Turbo (Fast & Efficient)</option>
                                        <option value="gpt-4" {% if podcast.openai_model == 'gpt-4' %}selected{% endif %}>GPT-4 (Advanced & Premium)</option>
                                        <option value="gpt-4-turbo" {% if podcast.openai_model == 'gpt-4-turbo' %}selected{% endif %}>GPT-4 Turbo (Best Balance)</option>
                                    </select>
                                    <div class="form-text">AI model used for content generation. More advanced models provide better quality but cost more credits.</div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3 text-center">
                                    <label class="form-label d-block">Cover Art</label>
                                    <div id="cover-art-preview" class="mb-2 rounded">
                                        {% if podcast.cover_art_path %}
                                            <img src="{{ url_for('static', filename=podcast.cover_art_path) }}" class="img-fluid rounded" style="max-height: 200px;" alt="Cover Art">
                                        {% else %}
                                            <div class="bg-secondary text-white text-center p-5 rounded">
                                                <i class="fas fa-image fa-3x"></i>
                                                <p class="mt-2" id="cover-art-text">No Cover Art</p>
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Cover art options -->
                                    <div class="d-flex gap-2 mb-2">
                                        <button type="button" class="btn btn-outline-primary flex-grow-1" id="generate-cover-btn">
                                            <i class="fas fa-magic me-1"></i> Generate with AI
                                        </button>
                                        <label for="cover_art" class="btn btn-outline-secondary flex-grow-1 mb-0">
                                            <i class="fas fa-upload me-1"></i> Upload
                                        </label>
                                    </div>
                                    
                                    <input type="file" class="form-control d-none" id="cover_art" name="cover_art" accept="image/*">
                                    <input type="hidden" id="generated_cover_path" name="generated_cover_path">
                                    <div class="form-text">Recommended: 1400Ã—1400 pixels, JPG or PNG</div>
                                    
                                    <!-- Cover generation progress -->
                                    <div id="cover-generation-progress" class="mt-2 d-none">
                                        <div class="progress">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                                        </div>
                                        <small class="text-muted">Generating cover art with DALL-E...</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="podcast_description" class="form-label">Description</label>
                            <textarea class="form-control" id="podcast_description" name="podcast_description" rows="4" required>{{ podcast.podcast_description }}</textarea>
                            <div class="form-text">Public description of your podcast that will appear in podcast directories.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="rss_slug" class="form-label">RSS Feed Slug</label>
                            <div class="input-group">
                                <span class="input-group-text">{{ request.host_url }}podcast/</span>
                                <input type="text" class="form-control" id="rss_slug" name="rss_slug" value="{{ podcast.rss_slug or '' }}" required>
                                <span class="input-group-text">/rss.xml</span>
                            </div>
                            <div class="form-text">URL-friendly name for your podcast's RSS feed. Use lowercase letters, numbers, and hyphens only.</div>
                        </div>
                        
                        {% if podcast.rss_slug %}
                        <div class="mb-4">
                            <div class="alert alert-info">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-rss fa-2x me-3"></i>
                                    <div>
                                        <h5 class="alert-heading mb-2">Your Podcast RSS Feed</h5>
                                        <p class="mb-1">Subscribe to this podcast in any podcast app using:</p>
                                        <div class="input-group mb-2">
                                            <input type="text" class="form-control" readonly value="{{ request.host_url }}podcast/{{ podcast.rss_slug }}/rss.xml">
                                            <button class="btn btn-outline-secondary" type="button" id="copy-rss-btn" 
                                                   onclick="navigator.clipboard.writeText('{{ request.host_url }}podcast/{{ podcast.rss_slug }}/rss.xml'); this.innerHTML='Copied!'; setTimeout(() => this.innerHTML='Copy', 2000)">
                                                Copy
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="mb-3">
                            <label for="ai_instructions" class="form-label">AI Instructions <span class="text-muted">(Optional)</span></label>
                            <textarea class="form-control" id="ai_instructions" name="ai_instructions" rows="6">{{ podcast.ai_instructions }}</textarea>
                            <div class="form-text">
                                Special instructions for the AI when generating your podcast content. Examples:
                                <ul class="mt-2">
                                    <li>Use a casual, conversational tone with occasional humor</li>
                                    <li>Focus on explaining technical concepts in simple terms</li>
                                    <li>Adopt a specific persona (e.g., "You are a cybersecurity expert with 20 years of experience")</li>
                                    <li>Use specific transitions or catchphrases</li>
                                </ul>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="blocked_terms" class="form-label">Blocked Words & Terms <span class="text-muted">(Optional)</span></label>
                            <textarea class="form-control" id="blocked_terms" name="blocked_terms" rows="3" placeholder="Enter terms separated by commas (e.g., politics, violence, controversial topics)">{{ podcast.blocked_terms }}</textarea>
                            <div class="form-text">
                                Words, phrases, or topics to exclude from your podcast. The system will filter out articles or content containing these terms.
                                <ul class="mt-2">
                                    <li>Enter multiple terms separated by commas</li>
                                    <li>Case-insensitive matching will be applied</li>
                                    <li>Can be used to block sensitive subjects or unwanted content</li>
                                </ul>
                            </div>
                        </div>

                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">RSS Feed Sources</h5>
                                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addFeedModal">
                                    <i class="fas fa-plus-circle me-1"></i> Add Feed
                                </button>
                            </div>
                            <div class="card-body p-0">
                                {% if podcast.feeds %}
                                <ul class="list-group list-group-flush" id="feedsList">
                                    {% for feed in podcast.feeds %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-0">{{ feed.name }}</h6>
                                            <p class="mb-0 small text-muted">{{ feed.url }}</p>
                                        </div>
                                        <div class="d-flex">
                                            <div class="form-check form-switch me-3">
                                                <input class="form-check-input" type="checkbox" role="switch" 
                                                       id="feed_active_{{ feed.id }}" name="feed_active_{{ feed.id }}"
                                                       {% if feed.active %}checked{% endif %}
                                                       onchange="updateFeedStatus({{ feed.id }}, this.checked)">
                                                <label class="form-check-label" for="feed_active_{{ feed.id }}">Active</label>
                                            </div>
                                            <button type="button" class="btn btn-sm btn-outline-danger" 
                                                    onclick="removeFeed({{ feed.id }}, '{{ feed.name }}')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </li>
                                    {% endfor %}
                                </ul>
                                {% else %}
                                <div class="p-4 text-center">
                                    <p class="mb-0 text-muted">No RSS feeds added yet. Add feeds to generate podcast content from.</p>
                                </div>
                                {% endif %}
                            </div>
                            <div class="card-footer bg-light">
                                <p class="mb-0 small">
                                    <i class="fas fa-info-circle me-1"></i> RSS feeds provide the news content for your podcast.
                                </p>
                            </div>
                        </div>
                        
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-microphone me-2"></i> Voice Settings</h5>
                            </div>
                            <div class="card-body">
                                <p class="mb-3">Configure the voice settings specific to this podcast. This will override the global voice settings.</p>
                                
                                <div class="mb-3">
                                    <label for="voice_id" class="form-label">Voice ID</label>
                                    <input type="text" class="form-control" id="voice_id" name="voice_id" 
                                           value="{{ podcast.voice_id or '' }}">
                                    <div class="form-text">
                                        The ID of the ElevenLabs voice to use. You can find voice IDs in the 
                                        <a href="https://elevenlabs.io/voice-library" target="_blank">ElevenLabs Voice Library</a>.
                                        Leave empty to use the global voice settings.
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="voice_stability" class="form-label">Stability ({{ podcast.voice_stability or '0.5' }})</label>
                                            <input type="range" class="form-range" id="voice_stability" name="voice_stability" 
                                                   min="0" max="1" step="0.05" value="{{ podcast.voice_stability or 0.5 }}">
                                            <div class="form-text">
                                                Controls the random variation in voice. Lower values allow more variation, higher values make the voice more stable.
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="voice_similarity_boost" class="form-label">Similarity Boost ({{ podcast.voice_similarity_boost or '0.5' }})</label>
                                            <input type="range" class="form-range" id="voice_similarity_boost" name="voice_similarity_boost" 
                                                   min="0" max="1" step="0.05" value="{{ podcast.voice_similarity_boost or 0.5 }}">
                                            <div class="form-text">
                                                Controls how closely the voice adheres to the voice's base character. Higher values make it sound more like the original voice.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mt-3">
                                    <div class="col-md-12">
                                        <h6 class="mb-2">Recommended Voices</h6>
                                        <div class="d-flex flex-wrap gap-2">
                                            <button type="button" class="btn btn-sm btn-outline-primary copy-voice-id" data-voice-id="OnrYGRgL7f1nDQqkQQOe">
                                                Daniel <small>(Male)</small>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-primary copy-voice-id" data-voice-id="21m00Tcm4TlvDq8ikWAM">
                                                Rachel <small>(Female)</small>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-primary copy-voice-id" data-voice-id="pNInz6obpgDQGcFmaJgB">
                                                Adam <small>(Male)</small>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-primary copy-voice-id" data-voice-id="ThT5KcBeYPX3keUQqHPh">
                                                Dorothy <small>(Female)</small>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Update voice stability and similarity boost labels when sliders change
    document.getElementById('voice_stability').addEventListener('input', function() {
        document.querySelector('label[for="voice_stability"]').innerHTML = 'Stability (' + this.value + ')';
    });
    
    document.getElementById('voice_similarity_boost').addEventListener('input', function() {
        document.querySelector('label[for="voice_similarity_boost"]').innerHTML = 'Similarity Boost (' + this.value + ')';
    });
    
    // Copy voice ID buttons
    document.querySelectorAll('.copy-voice-id').forEach(button => {
        button.addEventListener('click', function() {
            const voiceId = this.getAttribute('data-voice-id');
            document.getElementById('voice_id').value = voiceId;
            
            // Show feedback
            const originalHtml = this.innerHTML;
            this.classList.remove('btn-outline-primary');
            this.classList.add('btn-success');
            
            setTimeout(() => {
                this.classList.remove('btn-success');
                this.classList.add('btn-outline-primary');
            }, 1500);
        });
    });
    
    // Toggle active state for feeds
    function updateFeedStatus(feedId, isActive) {
        fetch(`/feeds/toggle/${feedId}?active=${isActive ? 1 : 0}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Feed status updated');
                } else {
                    console.error('Failed to update feed status');
                    // Revert the toggle if the update failed
                    document.getElementById(`feed_active_${feedId}`).checked = !isActive;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Revert the toggle if there was an error
                document.getElementById(`feed_active_${feedId}`).checked = !isActive;
            });
    }
    
    // Remove feed
    function removeFeed(feedId, feedName) {
        if (confirm(`Are you sure you want to delete the feed "${feedName}"?`)) {
            fetch(`/feeds/delete/${feedId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const feedItem = document.querySelector(`#feed_active_${feedId}`).closest('li');
                        feedItem.remove();
                        
                        // If no feeds are left, show the empty message
                        const feedsList = document.getElementById('feedsList');
                        if (feedsList && feedsList.children.length === 0) {
                            feedsList.innerHTML = `
                                <div class="p-4 text-center">
                                    <p class="mb-0 text-muted">No RSS feeds added yet. Add feeds to generate podcast content from.</p>
                                </div>
                            `;
                        }
                    } else {
                        alert('Failed to delete feed: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while trying to delete the feed.');
                });
        }
    }

    // Cover art generation functionality
    document.addEventListener('DOMContentLoaded', function() {
        const generateCoverBtn = document.getElementById('generate-cover-btn');
        const coverArtPreview = document.getElementById('cover-art-preview');
        const coverGenerationProgress = document.getElementById('cover-generation-progress');
        const podcastTitleInput = document.getElementById('podcast_title');
        const podcastDescriptionInput = document.getElementById('podcast_description');
        const generatedCoverPathInput = document.getElementById('generated_cover_path');
        const fileInput = document.getElementById('cover_art');
        
        // Show uploaded image preview
        fileInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    coverArtPreview.innerHTML = `<img src="${e.target.result}" class="img-fluid rounded" style="max-height: 200px;" alt="Cover Art">`;
                    generatedCoverPathInput.value = ''; // Clear any generated path
                }
                reader.readAsDataURL(this.files[0]);
            }
        });
        
        // Generate cover art button
        if (generateCoverBtn) {
            generateCoverBtn.addEventListener('click', function() {
                const title = podcastTitleInput.value.trim();
                const description = podcastDescriptionInput.value.trim();
                
                if (!title) {
                    alert('Please enter a podcast title first');
                    podcastTitleInput.focus();
                    return;
                }
                
                if (!description) {
                    alert('Please enter a podcast description first');
                    podcastDescriptionInput.focus();
                    return;
                }
                
                // Show loading state
                generateCoverBtn.disabled = true;
                generateCoverBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Generating...';
                coverGenerationProgress.classList.remove('d-none');
                
                // Make API request to generate cover
                fetch('/generate_cover_art', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        podcast_title: title,
                        podcast_description: description
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update preview with generated image
                        coverArtPreview.innerHTML = `<img src="${data.image_url}" class="img-fluid rounded" style="max-height: 200px;" alt="Generated Cover Art">`;
                        
                        // Store the file path in the hidden input - critical for saving to DB
                        generatedCoverPathInput.value = data.file_path;
                        console.log("Cover art path set:", data.file_path);
                        
                        // Clear file input
                        fileInput.value = '';
                    } else {
                        alert('Failed to generate cover art: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while generating cover art.');
                })
                .finally(() => {
                    // Reset UI
                    generateCoverBtn.disabled = false;
                    generateCoverBtn.innerHTML = '<i class="fas fa-magic me-1"></i> Generate with AI';
                    coverGenerationProgress.classList.add('d-none');
                });
            });
        }
    });
</script>
{% endblock %}