{% extends 'base.html' %}

{% block title %}{{ episode.title }} | AI Podcast Creator{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1 class="mb-2">{{ episode.title }}</h1>
        <p class="text-muted">
            <i class="fas fa-calendar me-1"></i> {{ episode.date.strftime('%Y-%m-%d') }}
            <span class="ms-3">
                {% if episode.status == 'draft' %}
                    <span class="badge bg-secondary">Draft</span>
                {% elif episode.status == 'script_generated' %}
                    <span class="badge bg-info">Script Ready</span>
                {% elif episode.status == 'audio_generated' %}
                    <span class="badge bg-warning">Audio Ready</span>
                {% elif episode.status == 'published' %}
                    <span class="badge bg-success">Published</span>
                {% endif %}
            </span>
        </p>
    </div>
    <div class="col-md-4 text-end d-flex align-items-center justify-content-end">
        {% if episode.status == 'script_generated' %}
            <button type="button" id="generateAudioBtn" class="btn btn-warning me-2" onclick="startAudioGeneration()">
                <i class="fas fa-volume-up me-1"></i> Generate Audio
            </button>
        {% elif episode.status == 'audio_generated' %}
            <a href="{{ url_for('publish', id=episode.id) }}" class="btn btn-success me-2">
                <i class="fas fa-upload me-1"></i> Publish
            </a>
        {% endif %}
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> Back
        </a>
    </div>

    {% if episode.status == 'script_generated' %}
    <div class="col-12 mt-3">
        <div class="alert alert-warning">
            <h5 class="mb-2"><i class="fas fa-coins me-2"></i>Audio Generation Cost Estimate</h5>
            <p>Generating audio for this podcast will use your ElevenLabs API credits:</p>
            <ul class="mb-1">
                <li><strong>Estimated cost:</strong> ~${{ (episode.script|length / 1000 * 0.03)|round(2) }} - ${{ (episode.script|length / 1000 * 0.06)|round(2) }}</li>
                <li><strong>Character count:</strong> {{ episode.script|length }} characters</li>
                <li><strong>Rate:</strong> ~$0.03-0.06 per 1,000 characters (varies by voice settings)</li>
            </ul>
            <p class="small mb-0 mt-2 text-dark">
                <i class="fas fa-info-circle me-1"></i> Higher stability and similarity settings will increase cost. Make sure you have enough 
                <a href="{{ url_for('voices') }}" class="alert-link">ElevenLabs credits</a> before proceeding.
            </p>
        </div>
    </div>
    {% endif %}

    <!-- Progress Bar Modal for Audio Generation -->
    <div class="modal fade" id="progressModal" tabindex="-1" aria-labelledby="progressModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="progressModalLabel">Generating Audio...</h5>
                </div>
                <div class="modal-body">
                    <p>Please wait while we convert your podcast script to audio.</p>
                    <div class="progress" style="height: 20px;">
                        <div id="audioProgress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">0%</div>
                    </div>
                    <p class="mt-3 small text-muted">This process may take 1-3 minutes depending on the length of your podcast.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    {% if episode.audio_path %}
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Audio</h5>
            </div>
            <div class="card-body">
                <audio controls class="w-100 mb-3">
                    <source src="{{ url_for('serve_audio', date=episode.audio_path.split('/')[1], filename='podcast.mp3') }}" type="audio/mpeg">
                    Your browser does not support the audio element.
                </audio>
                
                <div class="d-flex justify-content-end mb-3">
                    <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteAudioModal">
                        <i class="fas fa-trash me-1"></i> Delete Audio
                    </button>
                </div>
                
                {% if episode.publish_url %}
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-1"></i> Published to GitHub Pages
                    <a href="{{ episode.publish_url }}" target="_blank" class="alert-link ms-2">
                        <i class="fas fa-external-link-alt me-1"></i> View Online
                    </a>
                </div>
                {% endif %}
                
                <!-- Delete Audio Confirmation Modal -->
                <div class="modal fade" id="deleteAudioModal" tabindex="-1" aria-labelledby="deleteAudioModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="deleteAudioModalLabel">Confirm Delete</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p>Are you sure you want to delete the audio file for this episode?</p>
                                <p class="text-danger"><strong>Warning:</strong> This action cannot be undone. You will need to regenerate the audio if you want it back.</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <a href="{{ url_for('delete_audio', id=episode.id) }}" class="btn btn-danger">Delete Audio</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Podcast Script</h5>
                <button class="btn btn-sm btn-outline-secondary" id="copyScriptBtn">
                    <i class="fas fa-copy me-1"></i> Copy
                </button>
            </div>
            <div class="card-body">
                <pre class="script-content p-3 bg-dark text-light rounded">{{ episode.script }}</pre>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('copyScriptBtn').addEventListener('click', function() {
        const scriptContent = document.querySelector('.script-content').innerText;
        navigator.clipboard.writeText(scriptContent).then(function() {
            // Change button text temporarily
            const btn = document.getElementById('copyScriptBtn');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check me-1"></i> Copied!';
            btn.classList.remove('btn-outline-secondary');
            btn.classList.add('btn-success');
            
            setTimeout(function() {
                btn.innerHTML = originalHtml;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-secondary');
            }, 2000);
        });
    });
    
    // Audio generation progress handling
    function startAudioGeneration() {
        // Show the progress modal
        const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
        progressModal.show();
        
        // Initialize progress bar
        const progressBar = document.getElementById('audioProgress');
        let progress = 0;
        
        // Simulate progress while actual processing happens
        const interval = setInterval(function() {
            // Increment progress more slowly between 70-95% to simulate the longer TTS processing time
            if (progress < 30) {
                progress += 5; // Fast initial progress (preparing)
            } else if (progress < 70) {
                progress += 3; // Medium progress speed
            } else if (progress < 95) {
                progress += 0.5; // Slower progress (TTS processing)
            }
            
            if (progress >= 95) {
                clearInterval(interval);
                // At 95%, we'll wait for the actual completion
            }
            
            // Update the progress bar
            progressBar.style.width = progress + '%';
            progressBar.setAttribute('aria-valuenow', progress);
            progressBar.textContent = Math.round(progress) + '%';
        }, 300);
        
        // Make the actual AJAX request to generate audio
        fetch("{{ url_for('generate_audio', id=episode.id) }}")
            .then(response => {
                clearInterval(interval);
                
                if (response.ok) {
                    // Set progress to 100%
                    progressBar.style.width = '100%';
                    progressBar.setAttribute('aria-valuenow', 100);
                    progressBar.textContent = '100%';
                    
                    // Add success class
                    progressBar.classList.remove('bg-warning');
                    progressBar.classList.add('bg-success');
                    
                    // Redirect to the same page to show the audio player
                    setTimeout(function() {
                        window.location.reload();
                    }, 1000);
                } else {
                    // Handle error
                    progressBar.classList.remove('bg-warning');
                    progressBar.classList.add('bg-danger');
                    document.getElementById('progressModalLabel').textContent = 'Error Generating Audio';
                    
                    // Add a close button to the modal
                    const modalHeader = document.querySelector('#progressModal .modal-header');
                    const closeButton = document.createElement('button');
                    closeButton.type = 'button';
                    closeButton.className = 'btn-close';
                    closeButton.setAttribute('data-bs-dismiss', 'modal');
                    closeButton.setAttribute('aria-label', 'Close');
                    modalHeader.appendChild(closeButton);
                    
                    response.text().then(errorText => {
                        const errorMessage = document.createElement('div');
                        errorMessage.className = 'alert alert-danger mt-3';
                        errorMessage.textContent = "Error: " + errorText;
                        document.querySelector('#progressModal .modal-body').appendChild(errorMessage);
                    });
                }
            })
            .catch(error => {
                clearInterval(interval);
                progressBar.classList.remove('bg-warning');
                progressBar.classList.add('bg-danger');
                document.getElementById('progressModalLabel').textContent = 'Error';
                
                const errorMessage = document.createElement('div');
                errorMessage.className = 'alert alert-danger mt-3';
                errorMessage.textContent = "Network error: " + error.message;
                document.querySelector('#progressModal .modal-body').appendChild(errorMessage);
                
                // Add a close button to the modal
                const modalHeader = document.querySelector('#progressModal .modal-header');
                const closeButton = document.createElement('button');
                closeButton.type = 'button';
                closeButton.className = 'btn-close';
                closeButton.setAttribute('data-bs-dismiss', 'modal');
                closeButton.setAttribute('aria-label', 'Close');
                modalHeader.appendChild(closeButton);
            });
    }
</script>
{% endblock %}
